'use strict';
const { Model } = require('sequelize');

module.exports = (sequelize, DataTypes) => {
  class Tontine extends Model {
    static associate(models) {
      // Tontine appartient √† un organisateur
      Tontine.belongsTo(models.User, {
        foreignKey: 'organizerId',
        as: 'organizer'
      });
      
      // Une tontine a plusieurs participants
      Tontine.hasMany(models.TontineParticipant, {
        foreignKey: 'tontineId',
        as: 'participants'
      });
      
      // Une tontine a plusieurs transactions
      Tontine.hasMany(models.Transaction, {
        foreignKey: 'tontineId',
        as: 'transactions'
      });
      
      // Documents et attestations
      Tontine.hasMany(models.Document, {
        foreignKey: 'tontineId',
        as: 'documents'
      });
    }

    // Calculer commission mensuelle totale
    getMonthlyCommission() {
      const baseCommission = this.monthlyContribution * this.maxParticipants * 0.025; // 2.5%
      const fixedFees = this.maxParticipants * 0.25; // 0.25‚Ç¨ par participant
      return parseFloat((baseCommission + fixedFees).toFixed(2));
    }

    // Calculer montant net vers√©
    getNetPayout() {
      const totalCollected = this.monthlyContribution * this.maxParticipants;
      const commission = this.getMonthlyCommission();
      return parseFloat((totalCollected - commission).toFixed(2));
    }

    // V√©rifier si peut d√©marrer
    canStart() {
      return this.status === 'recruiting' && 
             this.currentParticipants >= this.maxParticipants &&
             this.organizerKycStatus === 'validated';
    }

    // Calculer progression
    getProgress() {
      if (this.status === 'completed') return 100;
      if (this.status === 'active') {
        return Math.round((this.currentRound / this.maxParticipants) * 100);
      }
      return Math.round((this.currentParticipants / this.maxParticipants) * 100);
    }
  }

  Tontine.init({
    id: {
      type: DataTypes.INTEGER,
      primaryKey: true,
      autoIncrement: true
    },
    
    // üë§ ORGANISATEUR
    organizerId: {
      type: DataTypes.INTEGER,
      allowNull: false,
      references: {
        model: 'users',
        key: 'id'
      }
    },
    
    // üè∑Ô∏è INFORMATIONS DE BASE
    title: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        len: [5, 100]
      },
      comment: 'Titre de la tontine ex: "Tontine √âpargne Auto 2025"'
    },
    
    description: {
      type: DataTypes.TEXT,
      allowNull: true
    },
    
    type: {
      type: DataTypes.ENUM('private', 'public'),
      allowNull: false,
      defaultValue: 'private'
    },
    
    // üí∞ PARAMETRES FINANCIERS
    monthlyContribution: {
      type: DataTypes.DECIMAL(8, 2),
      allowNull: false,
      validate: {
        min: 10.00,
        max: 10000.00
      },
      comment: 'Montant cotisation mensuelle par participant'
    },
    
    managementFees: {
      type: DataTypes.DECIMAL(6, 2),
      allowNull: false,
      defaultValue: 0.00,
      comment: 'Frais de gestion ajout√©s (calcul√©s automatiquement)'
    },
    
    totalMonthlyPayment: {
      type: DataTypes.DECIMAL(8, 2),
      allowNull: false,
      comment: 'monthlyContribution + managementFees'
    },
    
    payoutAmount: {
      type: DataTypes.DECIMAL(10, 2),
      allowNull: false,
      comment: 'Montant net vers√© au b√©n√©ficiaire'
    },
    
    currency: {
      type: DataTypes.STRING,
      allowNull: false,
      defaultValue: 'EUR',
      validate: {
        isIn: [['EUR', 'USD', 'XOF', 'GBP', 'CAD']]
      }
    },
    
    // üë• PARTICIPANTS
    maxParticipants: {
      type: DataTypes.INTEGER,
      allowNull: false,
      validate: {
        min: 3,
        max: 50
      }
    },
    
    currentParticipants: {
      type: DataTypes.INTEGER,
      defaultValue: 1,
      comment: 'Organisateur inclus automatiquement'
    },
    
    // ‚è∞ CALENDRIER
    durationMonths: {
      type: DataTypes.INTEGER,
      allowNull: false,
      comment: 'Dur√©e = maxParticipants (un tour par mois)'
    },
    
    contributionDay: {
      type: DataTypes.INTEGER,
      allowNull: false,
      defaultValue: 5,
      validate: {
        min: 1,
        max: 28
      },
      comment: 'Jour du mois pour cotisations (5 = 5 de chaque mois)'
    },
    
    payoutDay: {
      type: DataTypes.INTEGER,
      allowNull: false,
      defaultValue: 10,
      validate: {
        min: 1,
        max: 28
      },
      comment: 'Jour du mois pour versements'
    },
    
    startDate: {
      type: DataTypes.DATEONLY,
      allowNull: true,
      comment: 'Date de d√©marrage effective'
    },
    
    endDate: {
      type: DataTypes.DATEONLY,
      allowNull: true,
      comment: 'Date de fin pr√©vue'
    },
    
    // üé≤ TIRAGE AU SORT
    drawOrder: {
      type: DataTypes.JSON,
      allowNull: true,
      comment: 'Ordre tirage: [userId1, userId2, ...] apr√®s tirage'
    },
    
    drawDate: {
      type: DataTypes.DATE,
      allowNull: true,
      comment: 'Date du tirage au sort'
    },
    
    drawAlgorithm: {
      type: DataTypes.STRING,
      allowNull: true,
      defaultValue: 'secure_random',
      comment: 'Algorithme utilis√© pour tra√ßabilit√©'
    },
    
    drawSeed: {
      type: DataTypes.STRING,
      allowNull: true,
      comment: 'Seed pour reproductibilit√© du tirage'
    },
    
    // üìã CONDITIONS PARTICIPATION
    participationConditions: {
      type: DataTypes.JSON,
      allowNull: false,
      defaultValue: {
        identityDocumentRequired: false,
        incomeProofRequired: false,
        residenceProofRequired: false,
        residencePermitRequired: false,
        customConditions: []
      }
    },
    
    // üìä STATUT & PROGRESSION
    status: {
      type: DataTypes.ENUM(
        'draft',           // Brouillon (en cr√©ation)
        'recruiting',      // En recrutement
        'ready_to_start',  // Complet, pr√™t pour tirage
        'active',          // En cours d'ex√©cution
        'paused',          // Suspendue temporairement
        'completed',       // Termin√©e avec succ√®s
        'cancelled',       // Annul√©e
        'failed'           // √âchec (trop de d√©faillances)
      ),
      allowNull: false,
      defaultValue: 'draft'
    },
    
    currentRound: {
      type: DataTypes.INTEGER,
      defaultValue: 0,
      comment: 'Round en cours (0 = pas encore d√©marr√©)'
    },
    
    nextPayoutUserId: {
      type: DataTypes.INTEGER,
      allowNull: true,
      comment: 'ID du prochain b√©n√©ficiaire'
    },
    
    nextPayoutDate: {
      type: DataTypes.DATE,
      allowNull: true
    },
    
    // ‚úÖ KYC ORGANISATEUR
    organizerKycStatus: {
      type: DataTypes.ENUM('pending', 'validated', 'rejected'),
      allowNull: false,
      defaultValue: 'pending'
    },
    
    organizerKycValidatedAt: {
      type: DataTypes.DATE,
      allowNull: true
    },
    
    // üîí ACCES & SECURITE
    accessCode: {
      type: DataTypes.STRING,
      allowNull: true,
      comment: 'Code d\'acc√®s pour tontines priv√©es'
    },
    
    inviteOnly: {
      type: DataTypes.BOOLEAN,
      defaultValue: false,
      comment: 'Tontine sur invitation uniquement'
    },
    
    // üö® GESTION INCIDENTS
    defaultedParticipants: {
      type: DataTypes.JSON,
      allowNull: true,
      defaultValue: [],
      comment: 'Liste des participants d√©faillants exclus'
    },
    
    totalDefaultedAmount: {
      type: DataTypes.DECIMAL(10, 2),
      defaultValue: 0.00,
      comment: 'Montant total des d√©faillances'
    },
    
    incidentHistory: {
      type: DataTypes.JSON,
      allowNull: true,
      defaultValue: [],
      comment: 'Historique des incidents et r√©solutions'
    },
    
    // üîÑ ECHANGES DE POSITIONS
    positionExchanges: {
      type: DataTypes.JSON,
      allowNull: true,
      defaultValue: [],
      comment: 'Historique des √©changes de positions'
    },
    
    // üí≥ PAIEMENTS
    autoPaymentEnabled: {
      type: DataTypes.BOOLEAN,
      defaultValue: false,
      comment: 'Versements automatiques activ√©s'
    },
    
    paymentMethod: {
      type: DataTypes.ENUM('manual', 'automatic'),
      allowNull: false,
      defaultValue: 'manual'
    },
    
    // üìà STATISTIQUES
    totalAmountCollected: {
      type: DataTypes.DECIMAL(12, 2),
      defaultValue: 0.00
    },
    
    totalAmountPaidOut: {
      type: DataTypes.DECIMAL(12, 2),
      defaultValue: 0.00
    },
    
    totalCommissionsGenerated: {
      type: DataTypes.DECIMAL(8, 2),
      defaultValue: 0.00
    },
    
    averagePaymentDelay: {
      type: DataTypes.DECIMAL(4, 2),
      defaultValue: 0.00,
      comment: 'D√©lai moyen de paiement en jours'
    },
    
    // ‚≠ê REPUTATION & NOTES
    organizerRating: {
      type: DataTypes.DECIMAL(3, 2),
      allowNull: true,
      validate: {
        min: 0.00,
        max: 5.00
      }
    },
    
    participantsSatisfaction: {
      type: DataTypes.DECIMAL(3, 2),
      allowNull: true,
      validate: {
        min: 0.00,
        max: 5.00
      }
    },
    
    // üìù NOTES & COMMENTAIRES
    organizerNotes: {
      type: DataTypes.TEXT,
      allowNull: true,
      comment: 'Notes priv√©es de l\'organisateur'
    },
    
    publicDescription: {
      type: DataTypes.TEXT,
      allowNull: true,
      comment: 'Description publique pour tontines ouvertes'
    },
    
    // üè∑Ô∏è TAGS & CATEGORIES
    tags: {
      type: DataTypes.JSON,
      allowNull: true,
      defaultValue: [],
      comment: 'Tags: ["epargne", "auto", "etudiants"]'
    },
    
    category: {
      type: DataTypes.ENUM(
        'epargne_generale',
        'achat_vehicule', 
        'logement',
        'education',
        'mariage',
        'voyage',
        'investissement',
        'urgence',
        'autre'
      ),
      allowNull: true
    },
    
    // üì± VISIBILITE & RECHERCHE
    isPubliclyVisible: {
      type: DataTypes.BOOLEAN,
      defaultValue: true,
      comment: 'Visible dans la recherche publique'
    },
    
    searchKeywords: {
      type: DataTypes.STRING,
      allowNull: true,
      comment: 'Mots-cl√©s pour recherche'
    },
    
    // ‚öôÔ∏è CONFIGURATION AVANCEE
    allowPositionExchange: {
      type: DataTypes.BOOLEAN,
      defaultValue: true,
      comment: 'Autoriser √©changes de positions'
    },
    
    maxLatePaymentDays: {
      type: DataTypes.INTEGER,
      defaultValue: 7,
      comment: 'D√©lai max avant consid√©rer d√©faillant'
    },
    
    automaticExclusionEnabled: {
      type: DataTypes.BOOLEAN,
      defaultValue: true
    },
    
    // üåç LOCALISATION
    targetRegion: {
      type: DataTypes.STRING,
      allowNull: true,
      comment: 'R√©gion cible: "Europe", "Afrique de l\'Ouest"'
    },
    
    language: {
      type: DataTypes.STRING,
      allowNull: false,
      defaultValue: 'fr',
      validate: {
        isIn: [['fr', 'en', 'it', 'es']]
      }
    },
    
    timezone: {
      type: DataTypes.STRING,
      allowNull: false,
      defaultValue: 'Europe/Paris'
    },
    
    // üìä METADATA
    completionRate: {
      type: DataTypes.DECIMAL(5, 2),
      defaultValue: 0.00,
      comment: 'Pourcentage d\'avancement (0-100)'
    },
    
    estimatedEndDate: {
      type: DataTypes.DATEONLY,
      allowNull: true,
      comment: 'Date de fin estim√©e (calcul√©e)'
    },
    
    lastActivityAt: {
      type: DataTypes.DATE,
      allowNull: true
    }
    
  }, {
    sequelize,
    modelName: 'Tontine',
    tableName: 'tontines',
    underscored: true,
    timestamps: true,
    paranoid: true, // Soft delete
    
    hooks: {
      beforeCreate: (tontine) => {
        // Calculer frais de gestion et montant total
        const baseCommission = tontine.monthlyContribution * tontine.maxParticipants * 0.025;
        const fixedFees = tontine.maxParticipants * 0.25;
        tontine.managementFees = parseFloat((baseCommission + fixedFees).toFixed(2)) / tontine.maxParticipants;
        
        tontine.totalMonthlyPayment = parseFloat((tontine.monthlyContribution + tontine.managementFees).toFixed(2));
        
        // Calculer montant net vers√©
        const totalCollected = tontine.monthlyContribution * tontine.maxParticipants;
        const totalCommission = baseCommission + fixedFees;
        tontine.payoutAmount = parseFloat((totalCollected - totalCommission).toFixed(2));
        
        // Dur√©e = nombre de participants
        tontine.durationMonths = tontine.maxParticipants;
        
        // G√©n√©rer code d'acc√®s pour tontines priv√©es
        if (tontine.type === 'private' && !tontine.accessCode) {
          tontine.accessCode = Math.random().toString(36).substring(2, 10).toUpperCase();
        }
        
        // Mots-cl√©s de recherche automatiques
        if (!tontine.searchKeywords) {
          tontine.searchKeywords = `${tontine.title} ${tontine.monthlyContribution}‚Ç¨ ${tontine.maxParticipants}participants`;
        }
      },
      
      beforeUpdate: (tontine) => {
        // Mettre √† jour lastActivityAt
        tontine.lastActivityAt = new Date();
        
        // Recalculer le taux de compl√©tion
        if (tontine.status === 'completed') {
          tontine.completionRate = 100.00;
        } else if (tontine.status === 'active') {
          tontine.completionRate = parseFloat(((tontine.currentRound / tontine.maxParticipants) * 100).toFixed(2));
        } else if (tontine.status === 'recruiting') {
          tontine.completionRate = parseFloat(((tontine.currentParticipants / tontine.maxParticipants) * 100).toFixed(2));
        }
      },
      
      afterCreate: (tontine) => {
        console.log(`üí∞ Nouvelle tontine cr√©√©e: ${tontine.title} (${tontine.maxParticipants}√ó${tontine.monthlyContribution}‚Ç¨)`);
      }
    },
    
    indexes: [
      { fields: ['organizer_id'] },
      { fields: ['status'] },
      { fields: ['type'] },
      { fields: ['currency'] },
      { fields: ['start_date'] },
      { fields: ['is_publicly_visible'] },
      { fields: ['category'] },
      { fields: ['target_region'] },
      { fields: ['created_at'] }
    ]
  });

  return Tontine;
};
