//src/modules/associations/models/Association.js
"use strict";
const { Model } = require("sequelize");

module.exports = (sequelize, DataTypes) => {
  class Association extends Model {
    static associate(models) {
      // Une association a plusieurs sections
      Association.hasMany(models.Section, {
        foreignKey: "associationId",
        as: "sections",
      });

      // Une association a plusieurs membres (via AssociationMember)
      Association.hasMany(models.AssociationMember, {
        foreignKey: "associationId",
        as: "memberships",
      });

      // Une association a plusieurs transactions
      Association.hasMany(models.Transaction, {
        foreignKey: "associationId",
        as: "transactions",
      });

      // Documents l√©gaux
      Association.hasMany(models.Document, {
        foreignKey: "associationId",
        as: "documents",
      });
    }

    // Calculer le nombre de membres actifs
    async getActiveMembersCount() {
      const { AssociationMember } = sequelize.models;
      return await AssociationMember.count({
        where: {
          associationId: this.id,
          status: "active",
        },
      });
    }

    // Calculer le montant total en caisse
    async getTotalBalance() {
      const { Transaction } = sequelize.models;
      const result = await Transaction.findOne({
        where: { associationId: this.id },
        attributes: [
          [sequelize.fn("SUM", sequelize.col("net_amount")), "total"],
        ],
        raw: true,
      });
      return parseFloat(result?.total || 0);
    }
  }

  Association.init(
    {
      id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true,
      },


      // üè¢ INFORMATIONS DE BASE
      name: {
        type: DataTypes.STRING,
        allowNull: false,
        validate: {
          len: [3, 100],
        },
        comment: 'Nom de l\'association ex: "Diaspora Malienne Europe"',
      },

      slug: {
        type: DataTypes.STRING(255),
        allowNull: false,
        field: "slug",
        validate: {
          isLowercase: true,
          is: /^[a-z0-9-]+$/,
        },
        comment: 'URL-friendly: "diaspora-malienne-europe"',
      },

      description: {
        type: DataTypes.TEXT,
        allowNull: true,
      },

      // üèõÔ∏è STATUT LEGAL
      legalStatus: {
        type: DataTypes.ENUM(
          "association_1901",
          "asbl",
          "nonprofit_501c3",
          "other"
        ),
        allowNull: false,
        defaultValue: "association_1901",
      },

      registrationNumber: {
        type: DataTypes.STRING,
        allowNull: true,
        comment: "Num√©ro RNA/SIREN en France, etc.",
      },

      registrationDate: {
        type: DataTypes.DATEONLY,
        allowNull: true,
      },

      // üìç DOMICILIATION
      domiciliationCountry: {
        type: DataTypes.STRING,
        allowNull: false,
        defaultValue: "FR",
      },

      domiciliationCity: {
        type: DataTypes.STRING,
        allowNull: true,
      },

      headquartersAddress: {
        type: DataTypes.TEXT,
        allowNull: true,
      },

      // üí∞ INFORMATIONS FINANCIERES
      primaryCurrency: {
        type: DataTypes.STRING,
        allowNull: false,
        defaultValue: "EUR",
        validate: {
          isIn: [["EUR", "USD", "XOF", "GBP", "CAD"]],
        },
      },

      bankDetails: {
        type: DataTypes.JSON,
        allowNull: true,
        comment: "RIB principal: {iban, bic, bankName, accountHolder}",
      },

      // üîê SYST√àME RBAC DYNAMIQUE - R√îLES & PERMISSIONS
      rolesConfiguration: {
        type: DataTypes.JSONB,
        allowNull: false,
        defaultValue: {
          version: "1.0",
          roles: [],
          availablePermissions: [],
        },
        comment:
          "Configuration compl√®te des r√¥les et permissions (RBAC dynamique)",
      },

      // ‚öôÔ∏è CONFIGURATION FLEXIBLE
      memberTypes: {
        type: DataTypes.JSON,
        allowNull: false,
        defaultValue: {}, // ‚Üê VIDE - Admin configure
        comment: "Types de membres 100% configurables par l'admin",
      },

      cotisationSettings: {
        type: DataTypes.JSON,
        allowNull: false,
        defaultValue: {
          dueDay: 5,
          gracePeriodDays: 5,
          lateFeesEnabled: false,
          lateFeesAmount: 0,
          inactivityThresholdMonths: 3,
        },
      },

      // üìã STATUTS & VALIDATION
      status: {
        type: DataTypes.ENUM(
          "pending_validation",
          "active",
          "suspended",
          "dissolved"
        ),
        allowNull: false,
        defaultValue: "pending_validation",
      },

      validatedAt: {
        type: DataTypes.DATE,
        allowNull: true,
      },

      validatedBy: {
        type: DataTypes.INTEGER,
        allowNull: true,
        comment: "ID admin platform qui a valid√©",
      },

      // üìÑ DOCUMENTS LEGAUX
      documentsStatus: {
        type: DataTypes.JSON,
        allowNull: false,
        defaultValue: {
          statuts: { uploaded: false, validated: false, expiresAt: null },
          receipisse: { uploaded: false, validated: false, expiresAt: null },
          rib: { uploaded: false, validated: false, expiresAt: null },
          pv_creation: { uploaded: false, validated: false, expiresAt: null },
        },
      },

      // üåç MULTI-SECTIONS
      isMultiSection: {
        type: DataTypes.BOOLEAN,
        defaultValue: false,
        comment: "true si association avec sections g√©ographiques",
      },

      sectionsCount: {
        type: DataTypes.INTEGER,
        defaultValue: 0,
        comment: "Nombre de sections (cache)",
      },

      // üìä STATISTIQUES
      totalMembers: {
        type: DataTypes.INTEGER,
        defaultValue: 0,
      },

      activeMembers: {
        type: DataTypes.INTEGER,
        defaultValue: 0,
      },

      totalFundsRaised: {
        type: DataTypes.DECIMAL(12, 2),
        defaultValue: 0.0,
      },

      totalAidsGiven: {
        type: DataTypes.DECIMAL(12, 2),
        defaultValue: 0.0,
      },

      // üé® PERSONNALISATION
      theme: {
        type: DataTypes.JSON,
        allowNull: true,
        defaultValue: {
          primaryColor: "#2c5530",
          secondaryColor: "#4a7c59",
          logo: null,
        },
      },

      // üì± CONTACT & COMMUNICATION
      contactInfo: {
        type: DataTypes.JSON,
        allowNull: true,
        comment: "Email, t√©l√©phone, r√©seaux sociaux",
      },

      website: {
        type: DataTypes.STRING,
        allowNull: true,
        validate: {
          isUrl: true,
        },
      },

      // ‚öôÔ∏è CONFIGURATION AVANCEE
      subscriptionPlan: {
        type: DataTypes.ENUM("free", "standard", "premium", "enterprise"),
        allowNull: false,
        defaultValue: "standard",
      },

      subscriptionExpiresAt: {
        type: DataTypes.DATE,
        allowNull: true,
      },

      features: {
        type: DataTypes.JSON,
        allowNull: false,
        defaultValue: {
          maxMembers: 500,
          maxSections: 3,
          customTypes: true,
          advancedReports: false,
          apiAccess: false,
        },
      },

      incomeTypes: {
        type: DataTypes.JSONB,
        allowNull: true,
        defaultValue: {},
        field: "income_types",
        comment: "Types d'entr√©es d'argent configurables",
      },

      // üìà BUSINESS METRICS
      monthlyRevenue: {
        type: DataTypes.DECIMAL(8, 2),
        defaultValue: 0.0,
        comment: "Revenue g√©n√©r√© pour la plateforme (10‚Ç¨ + commissions)",
      },

      lastActivityAt: {
        type: DataTypes.DATE,
        allowNull: true,
      },
    },
    {
      sequelize,
      modelName: "Association",
      tableName: "associations",
      underscored: true,
      timestamps: true,
      paranoid: true,

      hooks: {
        beforeCreate: async (association) => {
          // G√©n√©rer slug automatiquement
          if (!association.slug) {
            association.slug = association.name
              .toLowerCase()
              .replace(/[^a-z0-9\s-]/g, "")
              .replace(/\s+/g, "-")
              .substring(0, 50);
          }

          // ‚úÖ NOUVEAU : Initialiser rolesConfiguration avec permissions de base
          if (
            !association.rolesConfiguration ||
            !association.rolesConfiguration.availablePermissions ||
            association.rolesConfiguration.availablePermissions.length === 0
          ) {
            association.rolesConfiguration = {
              version: "1.0",
              roles: [], // Vide - admin cr√©era les r√¥les
              availablePermissions: [
                // üìä FINANCES
                {
                  id: "view_finances",
                  name: "Consulter les finances",
                  category: "finances",
                  description: "Voir soldes, transactions, rapports",
                },
                {
                  id: "validate_expenses",
                  name: "Valider les d√©penses",
                  category: "finances",
                  description: "Approuver/rejeter demandes de d√©penses",
                },
                {
                  id: "export_financial_data",
                  name: "Exporter donn√©es financi√®res",
                  category: "finances",
                  description: "T√©l√©charger rapports CSV, Excel",
                },
                {
                  id: "manage_transactions",
                  name: "G√©rer les transactions",
                  category: "finances",
                  description: "Cr√©er, modifier, annuler transactions",
                },
                {
                  id: "manage_cotisations",
                  name: "G√©rer les cotisations",
                  category: "finances",
                  description: "Cr√©er, modifier, importer cotisations",
                },
                {
                  id: "view_balance",
                  name: "Consulter les soldes",
                  category: "finances",
                  description: "Voir solde association et sections",
                },

                // üë• MEMBRES
                {
                  id: "manage_members",
                  name: "G√©rer les membres",
                  category: "membres",
                  description: "Ajouter, modifier, supprimer membres",
                },
                {
                  id: "view_members",
                  name: "Consulter les membres",
                  category: "membres",
                  description: "Voir liste et d√©tails membres",
                },
                {
                  id: "assign_roles",
                  name: "Attribuer des r√¥les",
                  category: "membres",
                  description: "Changer les r√¥les des membres",
                },
                {
                  id: "manage_cotisations",
                  name: "G√©rer les cotisations",
                  category: "membres",
                  description: "Modifier montants cotisations",
                },

                // üèóÔ∏è SECTIONS
                {
                  id: "manage_sections",
                  name: "G√©rer les sections",
                  category: "sections",
                  description: "Cr√©er, modifier, supprimer sections",
                },
                {
                  id: "view_sections",
                  name: "Consulter les sections",
                  category: "sections",
                  description: "Voir d√©tails des sections",
                },

                // üì¢ COMMUNICATION
                {
                  id: "send_notifications",
                  name: "Envoyer des notifications",
                  category: "communication",
                  description: "SMS, emails aux membres",
                },
                {
                  id: "manage_announcements",
                  name: "G√©rer les annonces",
                  category: "communication",
                  description: "Publier communications",
                },

                // üìÑ DOCUMENTS
                {
                  id: "view_documents",
                  name: "Consulter les documents",
                  category: "documents",
                  description: "Acc√©der aux documents",
                },
                {
                  id: "upload_documents",
                  name: "T√©l√©verser des documents",
                  category: "documents",
                  description: "Ajouter nouveaux documents",
                },
                {
                  id: "manage_documents",
                  name: "G√©rer les documents",
                  category: "documents",
                  description: "Modifier, supprimer documents",
                },

                // üìÖ √âV√âNEMENTS
                {
                  id: "manage_events",
                  name: "G√©rer les √©v√©nements",
                  category: "evenements",
                  description: "Cr√©er, modifier √©v√©nements",
                },
                {
                  id: "view_events",
                  name: "Consulter les √©v√©nements",
                  category: "evenements",
                  description: "Voir calendrier √©v√©nements",
                },

                // ‚öôÔ∏è ADMINISTRATION
                {
                  id: "modify_settings",
                  name: "Modifier les param√®tres",
                  category: "administration",
                  description: "Changer configuration association",
                },
                {
                  id: "manage_roles",
                  name: "G√©rer les r√¥les",
                  category: "administration",
                  description: "Cr√©er, modifier, supprimer r√¥les",
                },
                {
                  id: "export_data",
                  name: "Exporter toutes les donn√©es",
                  category: "administration",
                  description: "Export complet sauvegarde",
                },
                {
                  id: "view_audit_logs",
                  name: "Consulter les logs",
                  category: "administration",
                  description: "Voir historique actions",
                },
              ],
            };
          }
        },

        afterCreate: (association) => {
          console.log(`üèõÔ∏è Nouvelle association cr√©√©e: ${association.name}`);
        },

        beforeUpdate: (association) => {
          association.lastActivityAt = new Date();
        },
      },

      indexes: [
        {
          fields: ["slug"],
          unique: true,
          name: "associations_slug_unique",
        },
        { fields: ["status"] },
        { fields: ["domiciliation_country"] },
        { fields: ["is_multi_section"] },
        { fields: ["subscription_plan"] },
        { fields: ["created_at"] },
      ],
    }
  );

  return Association;
};
