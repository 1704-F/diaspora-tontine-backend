// src/core/middleware/checkPermission.js
// üîê Middleware RBAC moderne pour DiasporaTontine
// Utilise le syst√®me de r√¥les et permissions dynamiques configurables

const { AssociationMember, Association, User } = require('../../models');

/**
 * üõ°Ô∏è Middleware pour v√©rifier l'appartenance √† une association
 * Doit √™tre utilis√© AVANT checkPermission
 */
const checkAssociationMember = async (req, res, next) => {
  try {
    console.log('üîç checkAssociationMember - V√©rification membership');
    
    // Extraire associationId de diff√©rentes sources
    let associationId = req.params.associationId || req.params.id;
    
    if (!associationId && req.body.associationId) {
      associationId = req.body.associationId;
    }
    
    if (!associationId) {
      return res.status(400).json({
        error: 'ID association manquant',
        code: 'MISSING_ASSOCIATION_ID'
      });
    }
    
    const parsedAssociationId = parseInt(associationId);
    if (isNaN(parsedAssociationId) || parsedAssociationId <= 0) {
      return res.status(400).json({
        error: 'ID association invalide',
        code: 'INVALID_ASSOCIATION_ID'
      });
    }
    
    if (!req.user?.id) {
      return res.status(401).json({
        error: 'Utilisateur non authentifi√©',
        code: 'NOT_AUTHENTICATED'
      });
    }
    
    const userId = parseInt(req.user.id);
    
    // R√©cup√©rer membership avec association et rolesConfiguration
    const membership = await AssociationMember.findOne({
      where: {
        userId: userId,
        associationId: parsedAssociationId,
        status: 'active'
      },
      include: [
        {
          model: Association,
          as: 'association',
          attributes: ['id', 'name', 'rolesConfiguration'],
          required: true
        },
        {
          model: User,
          as: 'user',
          attributes: ['id', 'firstName', 'lastName'],
          required: true
        }
      ]
    });
    
    if (!membership) {
      return res.status(403).json({
        error: 'Vous n\'√™tes pas membre de cette association',
        code: 'NOT_ASSOCIATION_MEMBER'
      });
    }
    
    // Attacher au request pour usage dans les routes
    req.membership = membership;
    req.associationId = parsedAssociationId;
    req.isAdmin = membership.isAdmin;
    
    console.log('   ‚úÖ Membership valid√©');
    console.log('   - User:', userId);
    console.log('   - Association:', parsedAssociationId);
    console.log('   - isAdmin:', membership.isAdmin);
    console.log('   - assignedRoles:', membership.assignedRoles);
    
    next();
    
  } catch (error) {
    console.error('‚ùå Erreur v√©rification membre:', error);
    res.status(500).json({
      error: 'Erreur v√©rification membre',
      code: 'MEMBERSHIP_CHECK_ERROR'
    });
  }
};

/**
 * üîê Middleware moderne pour v√©rifier une permission sp√©cifique
 * Utilise le syst√®me RBAC dynamique avec rolesConfiguration
 * 
 * @param {String} requiredPermission - ID de la permission requise
 * @returns {Function} Middleware Express
 */
function checkPermission(requiredPermission) {
  return async (req, res, next) => {
    try {
      const membership = req.membership;
      
      if (!membership) {
        return res.status(403).json({
          error: 'Membership non trouv√©. Utilisez checkAssociationMember avant.',
          code: 'MEMBERSHIP_REQUIRED'
        });
      }
      
      console.log(`üîç V√©rification permission: "${requiredPermission}"`);
      
      // ‚úÖ R√àGLE 1 : Admin association a TOUTES les permissions
      if (membership.isAdmin) {
        console.log('   ‚úÖ isAdmin=true - Acc√®s automatique accord√©');
        req.hasPermission = true;
        req.grantedBy = 'admin';
        return next();
      }
      
      // ‚úÖ R√àGLE 2 : V√©rifier customPermissions.granted (override)
      const customGranted = membership.customPermissions?.granted || [];
      if (customGranted.includes(requiredPermission)) {
        console.log('   ‚úÖ Permission dans customPermissions.granted');
        req.hasPermission = true;
        req.grantedBy = 'custom_granted';
        return next();
      }
      
      // ‚ùå R√àGLE 3 : V√©rifier customPermissions.revoked (blocage)
      const customRevoked = membership.customPermissions?.revoked || [];
      if (customRevoked.includes(requiredPermission)) {
        console.log('   ‚ùå Permission dans customPermissions.revoked');
        return res.status(403).json({
          error: 'Cette permission vous a √©t√© retir√©e',
          code: 'PERMISSION_REVOKED',
          required: requiredPermission
        });
      }
      
      // ‚úÖ R√àGLE 4 : V√©rifier dans les r√¥les attribu√©s
      const assignedRoles = membership.assignedRoles || [];
      const rolesConfig = membership.association?.rolesConfiguration?.roles || [];
      
      console.log('   - assignedRoles:', assignedRoles);
      console.log('   - rolesConfig disponibles:', rolesConfig.length);
      
      let hasPermissionViaRole = false;
      let grantedByRole = null;
      
      for (const roleId of assignedRoles) {
        const role = rolesConfig.find(r => r.id === roleId);
        
        if (role) {
          console.log(`   - V√©rification r√¥le "${role.name}" (${roleId})`);
          console.log(`     Permissions du r√¥le:`, role.permissions);
          
          if (role.permissions?.includes(requiredPermission)) {
            hasPermissionViaRole = true;
            grantedByRole = role.name;
            break;
          }
        }
      }
      
      if (hasPermissionViaRole) {
        console.log(`   ‚úÖ Permission accord√©e via r√¥le: ${grantedByRole}`);
        req.hasPermission = true;
        req.grantedBy = `role:${grantedByRole}`;
        return next();
      }
      
      // ‚ùå Aucune permission trouv√©e
      console.log('   ‚ùå Permission refus√©e - Aucun acc√®s trouv√©');
      
      return res.status(403).json({
        error: 'Permissions insuffisantes pour cette action',
        code: 'INSUFFICIENT_PERMISSIONS',
        required: requiredPermission,
        yourRoles: assignedRoles,
        hint: 'Contactez un administrateur pour obtenir les permissions n√©cessaires'
      });
      
    } catch (error) {
      console.error('‚ùå Erreur v√©rification permission:', error);
      res.status(500).json({
        error: 'Erreur v√©rification permissions',
        code: 'PERMISSION_CHECK_ERROR',
        details: error.message
      });
    }
  };
}

/**
 * üîß Fonction helper pour v√©rifier une permission sans middleware
 * Utile dans les controllers pour logique conditionnelle
 * 
 * @param {Object} membership - Instance AssociationMember
 * @param {String} permission - Permission √† v√©rifier
 * @returns {Boolean}
 */
function hasPermission(membership, permission) {
  if (!membership) return false;
  
  // Admin a tout
  if (membership.isAdmin) return true;
  
  // Custom granted
  const customGranted = membership.customPermissions?.granted || [];
  if (customGranted.includes(permission)) return true;
  
  // Custom revoked
  const customRevoked = membership.customPermissions?.revoked || [];
  if (customRevoked.includes(permission)) return false;
  
  // V√©rifier r√¥les
  const assignedRoles = membership.assignedRoles || [];
  const rolesConfig = membership.association?.rolesConfiguration?.roles || [];
  
  for (const roleId of assignedRoles) {
    const role = rolesConfig.find(r => r.id === roleId);
    if (role?.permissions?.includes(permission)) {
      return true;
    }
  }
  
  return false;
}

/**
 * üìä Fonction helper pour r√©cup√©rer toutes les permissions d'un membre
 * 
 * @param {Object} membership - Instance AssociationMember
 * @returns {Array<String>} Liste des IDs de permissions
 */
function getEffectivePermissions(membership) {
  if (!membership) return [];
  
  // Admin a toutes les permissions disponibles
  if (membership.isAdmin) {
    const availablePermissions = membership.association?.rolesConfiguration?.availablePermissions || [];
    return availablePermissions.map(p => p.id);
  }
  
  const permissions = new Set();
  
  // Permissions des r√¥les
  const assignedRoles = membership.assignedRoles || [];
  const rolesConfig = membership.association?.rolesConfiguration?.roles || [];
  
  for (const roleId of assignedRoles) {
    const role = rolesConfig.find(r => r.id === roleId);
    if (role?.permissions) {
      role.permissions.forEach(p => permissions.add(p));
    }
  }
  
  // Ajouter custom granted
  const customGranted = membership.customPermissions?.granted || [];
  customGranted.forEach(p => permissions.add(p));
  
  // Retirer custom revoked
  const customRevoked = membership.customPermissions?.revoked || [];
  customRevoked.forEach(p => permissions.delete(p));
  
  return Array.from(permissions);
}

/**
 * üéØ Middleware combin√© pour les routes communes
 * V√©rifie membership + permission en une seule cha√Æne
 * 
 * @param {String|null} permission - Permission optionnelle
 * @returns {Array<Function>} Tableau de middlewares
 */
const requireAssociationAccess = (permission = null) => {
  const middlewares = [checkAssociationMember];
  
  if (permission) {
    middlewares.push(checkPermission(permission));
  }
  
  return middlewares;
};

/**
 * üîÑ Middleware de r√©trocompatibilit√©
 * Permet migration douce depuis ancien syst√®me
 */
const checkFinancialValidationRights = () => {
  console.warn('‚ö†Ô∏è  checkFinancialValidationRights() est d√©pr√©ci√©. Utilisez checkPermission("validate_expenses")');
  return checkPermission('validate_expenses');
};

const checkFinancialViewRights = () => {
  console.warn('‚ö†Ô∏è  checkFinancialViewRights() est d√©pr√©ci√©. Utilisez checkPermission("view_finances")');
  return checkPermission('view_finances');
};

const checkMemberManagementRights = () => {
  console.warn('‚ö†Ô∏è  checkMemberManagementRights() est d√©pr√©ci√©. Utilisez checkPermission("manage_members")');
  return checkPermission('manage_members');
};

/**
 * üß™ Fonction de test pour d√©bugger les permissions
 * Usage : await debugPermissions(req.membership)
 */
async function debugPermissions(membership) {
  if (!membership) {
    console.log('‚ùå Aucun membership fourni');
    return;
  }
  
  console.log('\nüîç DEBUG PERMISSIONS');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('User ID:', membership.userId);
  console.log('Association ID:', membership.associationId);
  console.log('isAdmin:', membership.isAdmin);
  console.log('assignedRoles:', membership.assignedRoles);
  console.log('customPermissions:', membership.customPermissions);
  
  const effectivePerms = getEffectivePermissions(membership);
  console.log('\n‚úÖ Permissions effectives:');
  effectivePerms.forEach(p => console.log(`  - ${p}`));
  
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
}

// Exports
module.exports = {
  // Middlewares principaux (NOUVEAUX)
  checkAssociationMember,
  checkPermission,
  requireAssociationAccess,
  
  // Fonctions helper
  hasPermission,
  getEffectivePermissions,
  debugPermissions,
  
  // R√©trocompatibilit√© (D√âPR√âCI√âS - √† supprimer apr√®s migration)
  checkFinancialValidationRights,
  checkFinancialViewRights,
  checkMemberManagementRights
};